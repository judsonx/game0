<!doctype HTML>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.25">
  <title>Game0</title>
  <link rel="stylesheet" type="text/css" href="assets/style/site.css">
</head>
<body>
<header>
    <h1>game0</h1>
</header>
<div class="content">
  <div>
    <table>
      <tr><td>Level:</td><td id="level">0</td></tr>
      <tr><td>Score:</td><td id="score">0</td></tr>
      <tr><td>Lines:</td><td id="lines">0</td></tr>
      <tr><td>Status:</td><td id="status">Not Started</td></tr>
      <tr>
        <td><input type="button" id="reset" value="Start"/></td>
        <td><input type="button" id="pause" value="Pause" disabled/></td>
      </tr>
    </table>
  </div>
  <div id="play_area">
    <div id="group">
      <div id="pa"></div>
      <div id="ga"></div>
      <div id="ca">
        <table>
          <tr>
            <td colspan="2" id="toggle">Rotate</td>
          </tr>
          <tr>
            <td id="left">Left</td>
            <td id="right">Right</td>
          </tr>
          <tr>
            <td colspan="2" id="down">Down</td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js">
</script>
<script src="assets/js/game0.js"></script>
<script>
game0.init ({
  game_area: $('#ga'),
  preview_area: $('#pa'),
});

var current_level = 0;
var levels = [ 1100, 1000, 900, 800, 700, 600, 500, 400, 300, 200, 150 ];

// See: http://stackoverflow.com/questions/15804296/
// how-to-prevent-doubletap-zoom-in-ios-and-android
$('body').on ('touchstart', function (e) {
  var t2 = e.timeStamp;
  var t1 = $(this).data('lastTouch') || t2;
  var dt = t2 - t1;
  var fingers = e.originalEvent.touches.length;
  $(this).data('lastTouch', t2);
  if (!dt || dt > 500 || fingers > 1){
    return; // not double-tap
  }
  e.preventDefault(); // double tap - prevent the zoom
  // also synthesize click events we just swallowed up
  $(e.target).trigger('click');
});

$('#left').on ('click', function () { game0.on_ctrl_left (); });
$('#right').on ('click', function () { game0.on_ctrl_right (); });
$('#toggle').on ('click', function () { game0.on_ctrl_toggle (); });
$('#down').on ('click', function () { game0.on_ctrl_down (); });

$(document).on ('keydown', function (e) {
  switch (e.keyCode)
  {
  case 38:
    game0.on_ctrl_toggle ();
    return false;
  case 40:
    game0.on_ctrl_down ();
    return false;
  case 37:
    game0.on_ctrl_left ();
    return false;
  case 39:
    game0.on_ctrl_right ();
    return false;
  }
});

var timer0 = { interval: 1000 }

function set_status (status)
{
  $('#status').text (status);
}

function unpause ()
{
  var e = $('#pause');
  e.prop ('disabled', false);
  e.unbind ('click');
  timer0.id = setInterval (step, timer0.interval);
  e.prop ('value', "Pause").on ('click', pause);
  set_status ('In-Progress');
  game0.set_paused (false);
  $('.row > div').css ('opacity', 1);
}

function pause (timer)
{
  var e = $('#pause');
  e.unbind ('click');
  clearInterval (timer0.id);
  e.prop ('value', "Continue").on ('click', unpause);
  set_status ('Paused');
  game0.set_paused (true);
  $('.row > div').css ('opacity', 0);
}

function set_level (lines)
{
  var level = Math.floor (lines / 10);
  if (level != current_level)
  {
    if (level < levels.length)
    {
      clearInterval (timer0.id);
      timer0.id = setInterval (step, levels[level]);
      current_level = level;
      $('#level').text (level);
    }
  }
}

function step ()
{
  if (!game0.step ())
  {
    clearInterval (timer0.id);
    set_status ('Game Over!');
    $('#pause').prop ('disabled', true);
  }
  var lines = game0.get_lines ();
  $('#score').text (game0.get_score ());
  $('#lines').text (lines);
  set_level (lines);
}

$('#reset').on ('click', function () {
  if (timer0.hasOwnProperty ('id'))
    clearInterval (timer0.id);
  set_status ('In-Progress');
  $('#reset').prop ('value', 'Re-Start');
  game0.reset ();
  set_level (0);
  unpause ();
});

</script>
</body>
</html>
